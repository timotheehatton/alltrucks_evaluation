{% extends "layout.html" %}
{% load static %}

{% block stylesheets %}
    {% if user.is_superuser == True %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/admin/style.css' %}">
    {% endif %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/templates/manager/stats/style.css' %}">
{% endblock %}

{% block sidebar %}{{ block.super }}{% endblock sidebar %}

{% block body %}
    <div class="content">
    <div class="stats stats-admin">

        {% if user.is_superuser == True %}
            <a href="{% url 'admin:workshops' %}" class="button-back"><i class="material-icons">arrow_back</i>All
                Workshops</a>
        {% else %}
            <h1 class="page-title"><i
                    class="material-icons page-title-icon">bar_chart</i> {{ page_content.user_statistic.page_title }}
            </h1>
        {% endif %}


        {# ADMIN PART #}
        {% if user.is_superuser == True %}
            <div class="row">
            <div class="col s6">
            <div class="card stats-admin-details">
                <div class="stats-info-title"><i class="material-icons left">business</i>Workshop information</div>
                <form method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="update_workshop_info" value="1">
                    <div class="row">
                        <div class="col s5">
                            <div class="stats-info-item">
                                <div class="input-field">
                                    <input id="company_name" name="company_name" type="text" class="validate" value="{{ current_user.name }}" required>
                                    <label for="company_name" class="active">Company Name</label>
                                </div>
                            </div>
                        </div>
                        <div class="col s1"></div>
                        <div class="col s6">
                            <div class="stats-info-item">
                                <div class="input-field">
                                    <input id="city" name="city" type="text" class="validate" value="{{ current_user.city }}" required>
                                    <label for="city" class="active">City</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s5">
                            <div class="stats-info-item">
                                <div class="input-field">
                                    <select id="country" name="country" required>
                                        <option value="FR" {% if current_user.country == 'FR' %}selected{% endif %}>FR</option>
                                        <option value="ES" {% if current_user.country == 'ES' %}selected{% endif %}>ES</option>
                                        <option value="PL" {% if current_user.country == 'PL' %}selected{% endif %}>PL</option>
                                        <option value="DE" {% if current_user.country == 'DE' %}selected{% endif %}>DE</option>
                                    </select>
                                    <label for="country">Country</label>
                                </div>
                            </div>
                        </div>
                        <div class="col s1"></div>
                        <div class="col s6">
                            <div class="stats-info-item">
                                <div class="input-field">
                                    <input id="cu_number" name="cu_number" type="text" class="validate" value="{{ current_user.cu_number }}" required>
                                    <label for="cu_number" class="active">CU Number</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s6">
                            <div class="stats-info-item">
                                <button class="btn waves-effect waves-light" type="submit" style="margin-top: 20px;">
                                    Update Workshop Info
                                    <i class="material-icons right">save</i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                {% if messages %}
                    <div class="row">
                        <div class="col s12" style="margin-top: 20px;">
                            {% for message in messages %}
                                {% if "success" in message.tags %}
                                    <div class="card-panel green lighten-4 green-text text-darken-4">
                                        <i class="material-icons left">check_circle</i>
                                        {{ message }}
                                    </div>
                                {% elif "warning" in message.tags %}
                                    <div class="card-panel orange lighten-4 orange-text text-darken-4">
                                        <i class="material-icons left">warning</i>
                                        {{ message }}
                                    </div>
                                {% elif "error" in message.tags %}
                                    <div class="card-panel red lighten-4 red-text text-darken-4">
                                        <i class="material-icons left">error</i>
                                        {{ message }}
                                    </div>
                                {% else %}
                                    <div class="card-panel grey lighten-4 grey-text text-darken-4">
                                        <i class="material-icons left">info</i>
                                        {{ message }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
            </div>


            <div class="col s1">
            </div>
            <div class="col s5">

            <div class="card stats-admin-details" style="background-color: #ffebee;">
                <div class="row">
                    <div class="stats-info-title" style="color: #c62828;"><i class="material-icons left" style="color: #c62828;">warning</i>Danger Zone</div>
                    <div class="col s12">
                        <p style="margin-bottom: 20px;">Deleting this workshop will permanently remove:</p>
                        <ul style="margin-left: 20px; margin-bottom: 20px;">
                            <li>• The workshop information</li>
                            <li>• {{ managers|length }} manager{% if managers|length != 1 %}s{% endif %}</li>
                            <li>• {{ technicians|length }} technician{% if technicians|length != 1 %}s{% endif %}</li>
                            <li>• All technician scores and quiz results</li>
                        </ul>
                        <form id="delete-workshop-form" method="post" action="{% url 'admin:delete_workshop' current_user.id %}">
                            {% csrf_token %}
                            <button type="button" class="btn red" onclick="confirmDelete()">
                                <i class="material-icons left">delete_forever</i>Delete Workshop
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            </div>
            </div>

            <div class="card stats-admin-details">
                <div class="stats-info-title"><i class="material-icons left">people</i>Workshop users ({{ workshop_users|length }})</div>

                <div class="model-list-table" style="max-height: 500px; overflow-y: auto; margin-top: 20px;">
                    <table class="highlight responsive-table">
                        <thead style="position: sticky; top: 0; background-color: white; z-index: 10; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);">
                            <tr>
                                <th>USER TYPE</th>
                                <th>NAME</th>
                                <th>EMAIL</th>
                                <th>LANGUAGE</th>
                                <th>ACCOUNT ACTIVATION</th>
                                <th>FIRST EVALUATION</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in workshop_users %}
                                <tr>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">
                                        <span class="user-type-badge user-type-{{ user.user_type }}">
                                            {{ user.user_type }}
                                        </span>
                                    </td>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">{{ user.first_name|title }} {{ user.last_name|upper }}</td>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">{{ user.email }}</td>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">{{ user.language|upper }}</td>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">
                                        {% if user.is_active %}
                                            <span class="status-completed"><i class="material-icons">check_circle</i> Activated</span>
                                        {% else %}
                                            <span class="status-not-completed"><i class="material-icons">schedule</i> Not Activated</span>
                                        {% endif %}
                                    </td>
                                    <td class="clickable-cell" onclick="window.location.href='{% url 'admin:single_user' user.id %}'">
                                        {% if user.user_type == 'technician' %}
                                            {% if user.has_completed_test %}
                                                <span class="status-completed"><i class="material-icons">check_circle</i> Completed</span>
                                            {% else %}
                                                <span class="status-not-completed"><i class="material-icons">schedule</i> Not completed</span>
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" action="{% url 'admin:delete_user' user.id %}" style="display: inline;" onsubmit="return confirmUserDelete(event, '{{ user.first_name|title }} {{ user.last_name|upper }}', '{{ user.user_type }}')">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-small red" style="padding: 0 10px;">
                                                <i class="material-icons">delete</i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">No users assigned to this workshop</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card stats-admin-details">
                <div class="stats-info-title"><i class="material-icons left">person_add</i>Add User to Workshop</div>

                <form method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="add_user_to_workshop" value="1">

                    <div class="row" style="margin-top: 20px;">
                        <div class="col s6">
                            <div class="input-field">
                                <select id="user_type" name="user_type" required>
                                    <option value="" disabled selected>Choose user type</option>
                                    <option value="manager">Manager</option>
                                    <option value="technician">Technician</option>
                                </select>
                                <label>User Type</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col s6">
                            <div class="input-field">
                                <input id="first_name" name="first_name" type="text" class="validate" required>
                                <label for="first_name">First Name</label>
                            </div>
                        </div>
                        <div class="col s1"></div>
                        <div class="col s5">
                            <div class="input-field">
                                <input id="last_name" name="last_name" type="text" class="validate" required>
                                <label for="last_name">Last Name</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col s6">
                            <div class="input-field">
                                <input id="email" name="email" type="email" class="validate" required>
                                <label for="email">Email Address</label>
                            </div>
                        </div>
                        <div class="col s1"></div>
                        <div class="col s5">
                            <div class="input-field">
                                <input id="ct_number" name="ct_number" type="text" class="validate" required>
                                <label for="ct_number">CT Number</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col s12">
                            <button class="btn blue waves-effect waves-light" type="submit">
                                <i class="material-icons left">person_add</i>
                                Add User
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            {# END ADMIN PART #}
        {% endif %}

        <div class="row">
            <div class="col s8">
                <div class="card">
                    <div class="graph">
                        <canvas id="radarChart" height="515"></canvas>
                    </div>
                    <div id="legend-container"></div>
                    {% if not global_scores %}
                        <div class="graph-no-data">
                            {{ page_content.user_statistic.manager_no_data_placeholder }}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% if global_scores %}
                <div class="col s4">
                    <div class="card">
                        <div class="category-scores">
                            {% for category, score in global_scores.items %}
                                <div class="category-score">
                                    <div class="category-title">{{ category }} <span
                                            class="score-percentage">{{ score }}%</span></div>
                                    <div class="progress">
                                        <div class="determinate {% if score >= 30 %}green{% else %}orange{% endif %}"
                                             style="width: {{ score }}%"></div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const GLOBAL_SCORE = {{ global_scores|safe }};
        const TECHNICIAN_SCORES = [
            {% for key, value in technician_scores.items %}
                {
                    name: "{{ key.0 }}",
                    id: {{ key.1 }},
                    values: {{ value|safe }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>
    <script src="{% static 'js/maps/manager.js' %}"></script>
    
    {% if user.is_superuser == True %}
    <script>
        function confirmDelete() {
            const workshopName = "{{ current_user.name }}";
            const managerCount = {{ managers|length }};
            const technicianCount = {{ technicians|length }};

            const message = `Are you sure you want to delete the workshop "${workshopName}"?\n\n` +
                `This action will permanently delete:\n` +
                `• The workshop information\n` +
                `• ${managerCount} manager${managerCount !== 1 ? 's' : ''}\n` +
                `• ${technicianCount} technician${technicianCount !== 1 ? 's' : ''}\n` +
                `• All technician scores and quiz results\n\n` +
                `This action cannot be undone!`;

            if (confirm(message)) {
                document.getElementById('delete-workshop-form').submit();
            }
        }

        function confirmUserDelete(event, userName, userType) {
            event.preventDefault();

            const message = `Are you sure you want to delete the ${userType} "${userName}"?\n\n` +
                `This action will permanently delete:\n` +
                `• The user account\n` +
                (userType === 'technician' ? `• All quiz scores and results\n` : '') +
                `\nThis action cannot be undone!`;

            if (confirm(message)) {
                event.target.submit();
            }

            return false;
        }
    </script>
    {% endif %}
{% endblock %}